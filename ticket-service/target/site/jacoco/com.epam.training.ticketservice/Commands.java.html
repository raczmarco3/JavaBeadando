<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="hu"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Commands.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ticket-service</a> &gt; <a href="index.source.html" class="el_package">com.epam.training.ticketservice</a> &gt; <span class="el_source">Commands.java</span></div><h1>Commands.java</h1><pre class="source lang-java linenums">package com.epam.training.ticketservice;

import com.epam.training.ticketservice.controller.*;
import com.epam.training.ticketservice.controller.UserController;
import com.epam.training.ticketservice.model.Price;
import com.epam.training.ticketservice.model.User;
import com.epam.training.ticketservice.model.Room;
import com.epam.training.ticketservice.model.Screening;
import com.epam.training.ticketservice.model.Book;
import com.epam.training.ticketservice.model.Movie;
import org.springframework.shell.standard.ShellComponent;
import org.springframework.shell.standard.ShellMethod;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

@Component
@ShellComponent
public class Commands {
    private MovieController movieController;
    private RoomController roomController;
    private ScreeningController screeningController;
<span class="fc" id="L26">    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm&quot;);</span>
    private UserController userContorller;
    private BookController bookController;
    private PriceComponentController priceComponentController;
    private PriceComponentSetController priceComponentSetController;
<span class="fc" id="L31">    private User user = new User();</span>
<span class="fc" id="L32">    private Price price = new Price();</span>


    public Commands(MovieController movieController, RoomController roomController,
                    ScreeningController screeningController, UserController userContorller,
                    BookController bookController, PriceComponentController priceComponentController,
<span class="fc" id="L38">                    PriceComponentSetController priceComponentSetController) {</span>
<span class="fc" id="L39">        this.movieController = movieController;</span>
<span class="fc" id="L40">        this.roomController = roomController;</span>
<span class="fc" id="L41">        this.screeningController = screeningController;</span>
<span class="fc" id="L42">        this.userContorller = userContorller;</span>
<span class="fc" id="L43">        this.bookController = bookController;</span>
<span class="fc" id="L44">        this.priceComponentController = priceComponentController;</span>
<span class="fc" id="L45">        this.priceComponentSetController = priceComponentSetController;</span>
<span class="fc" id="L46">        userContorller.createUser(&quot;admin&quot;, &quot;admin&quot;, true);</span>
<span class="fc" id="L47">        this.user.setLoggedIn(false);</span>
<span class="fc" id="L48">        this.user.setAdmin(false);</span>
<span class="fc" id="L49">        this.price.setPrice(1500);</span>
<span class="fc" id="L50">    }</span>
    public void setAdmin() {
<span class="fc" id="L52">        this.user.setAdmin(true);</span>
<span class="fc" id="L53">    }</span>
    @ShellMethod(value = &quot;Create a movie.&quot;, key = &quot;create movie&quot;)
    public void createMovie(String title, String genre, int length) {
<span class="pc bpc" id="L56" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L57">            movieController.createMovie(title, genre, length);</span>
        } else {
<span class="nc" id="L59">            System.out.println(&quot;createMovie command is for privileged users&quot;);</span>
        }
<span class="fc" id="L61">    }</span>

    @ShellMethod(value = &quot;List all movies.&quot;, key = &quot;list movies&quot;)
    public void listAllMovies() {
<span class="fc" id="L65">        List&lt;Movie&gt; movies = movieController.getAllMovies();</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">        if (movies.size() == 0) {</span>
<span class="fc" id="L67">            System.out.println(&quot;There are no movies at the moment&quot;);</span>
        } else {
<span class="fc bfc" id="L69" title="All 2 branches covered.">            for (Movie movie : movies) {</span>
<span class="fc" id="L70">                System.out.println(String.format(&quot;%s (%s, %s minutes)&quot;,</span>
<span class="fc" id="L71">                        movie.getTitle(),</span>
<span class="fc" id="L72">                        movie.getGenre(),</span>
<span class="fc" id="L73">                        movie.getLength()</span>
                ));
<span class="fc" id="L75">            }</span>
        }
<span class="fc" id="L77">    }</span>

    @ShellMethod(value = &quot;Delete a movie from the database.&quot;, key = &quot;delete movie&quot;)
    public void deleteMovie(String title) {
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L82">            movieController.deleteMovie(title);</span>
        } else {
<span class="nc" id="L84">            System.out.println(&quot;deleteMovie command is for privileged users&quot;);</span>
        }
<span class="fc" id="L86">    }</span>

    @ShellMethod(value = &quot;Update a movie that is already exists in the database.&quot;, key = &quot;update movie&quot;)
    public void updateMovie(String title, String genre, int length) {
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L91">            movieController.updateMovie(title, genre, length);</span>
        } else {
<span class="nc" id="L93">            System.out.println(&quot;updateMovie command is for privileged users&quot;);</span>
        }
<span class="fc" id="L95">    }</span>

    @ShellMethod(value = &quot;Create a room.&quot;, key = &quot;create room&quot;)
    public void createRoom(String name, int rows, int columns) {
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L100">            roomController.createRoom(name, rows, columns);</span>
        } else {
<span class="nc" id="L102">            System.out.println(&quot;createRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L104">    }</span>

    @ShellMethod(value = &quot;List all rooms.&quot;, key = &quot;list rooms&quot;)
    public void listAllRooms() {
<span class="fc" id="L108">        List&lt;Room&gt; rooms = roomController.getAllRooms();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (rooms.size() == 0) {</span>
<span class="fc" id="L110">            System.out.println(&quot;There are no rooms at the moment&quot;);</span>
        } else {
<span class="fc bfc" id="L112" title="All 2 branches covered.">            for (Room room : rooms) {</span>
<span class="fc" id="L113">                System.out.println(String.format(&quot;Room %s with %d seats, %d rows and %d columns&quot;,</span>
<span class="fc" id="L114">                        room.getName(),</span>
<span class="fc" id="L115">                        room.getSeats(),</span>
<span class="fc" id="L116">                        room.getRows(),</span>
<span class="fc" id="L117">                        room.getColumns()</span>
                ));
<span class="fc" id="L119">            }</span>
        }
<span class="fc" id="L121">    }</span>

    @ShellMethod(value = &quot;Update a room that is already exists in the database.&quot;, key = &quot;update room&quot;)
    public void updateRoom(String name, int rows, int columns) {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L126">            roomController.updateRoom(name, rows, columns);</span>
        } else {
<span class="nc" id="L128">            System.out.println(&quot;updateRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L130">    }</span>

    @ShellMethod(value = &quot;Delete a room from the database&quot;, key = &quot;delete room&quot;)
    public void deleteRoom(String name) {
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L135">            roomController.deleteRoom(name);</span>
        } else {
<span class="nc" id="L137">            System.out.println(&quot;deleteRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L139">    }</span>

    @ShellMethod(value = &quot;Create a screening.&quot;, key = &quot;create screening&quot;)
    public void createScreening(String movieTitle, String roomName, String dateTime) {
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L144">            List&lt;Screening&gt; screenings = screeningController.getAllScreenings();</span>
<span class="fc" id="L145">            LocalDateTime date = LocalDateTime.parse(dateTime, formatter);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">            if (screenings.size() == 0) {</span>
<span class="fc" id="L147">                screeningController.createScreaning(movieTitle, roomName, date);</span>
            } else {
<span class="fc" id="L149">                List&lt;Screening&gt; screenings2 = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L150">                screeningController.getAllScreenings().stream()</span>
<span class="fc" id="L151">                        .filter(screening -&gt; screening.getRoomName().equals(roomName))</span>
<span class="fc" id="L152">                        .forEach(screening -&gt; screenings2.add(screening));</span>
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">                if (screenings2.size() == 0) {</span>
<span class="nc" id="L154">                    screeningController.createScreaning(movieTitle, roomName, date);</span>
                } else {
<span class="fc" id="L156">                    boolean match = false;</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">                    for (Screening screening : screenings2) {</span>
<span class="pc bpc" id="L158" title="3 of 4 branches missed.">                        if (date.isBefore(screening.getEndTime()) &amp;&amp; date.isAfter(screening.getDateTime())) {</span>
<span class="nc" id="L159">                            System.out.println(&quot;There is an overlapping screening&quot;);</span>
<span class="nc" id="L160">                            match = true;</span>
<span class="nc" id="L161">                            break;</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">                        } else if (date.isBefore(screening.getEndTime().plusMinutes(10))</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">                                &amp;&amp; date.isAfter(screening.getEndTime())) {</span>
<span class="nc" id="L164">                            System.out.println(&quot;This would start in the break &quot;</span>
                                    + &quot;period after another screening in this room&quot;);
<span class="nc" id="L166">                            match = true;</span>
<span class="nc" id="L167">                            break;</span>
                        }
<span class="fc" id="L169">                    }</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">                    if (!match) {</span>
<span class="fc" id="L171">                        screeningController.createScreaning(movieTitle, roomName, date);</span>
                    }
                }
            }
<span class="fc" id="L175">        } else {</span>
<span class="nc" id="L176">            System.out.println(&quot;createScreening command is for privileged users&quot;);</span>
        }
<span class="fc" id="L178">    }</span>

    @ShellMethod(value = &quot;List all screenings.&quot;, key = &quot;list screenings&quot;)
    public void listAllscreenings() {
<span class="fc" id="L182">        List&lt;Screening&gt; screenings = screeningController.getAllScreenings();</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">        if (screenings.size() == 0) {</span>
<span class="fc" id="L184">            System.out.println(&quot;There are no screenings&quot;);</span>
        } else {
<span class="fc bfc" id="L186" title="All 2 branches covered.">            for (Screening screening : screenings) {</span>
<span class="fc" id="L187">                System.out.println(String.format(&quot;%s (%s, %d minutes), screened in room %s, at %s&quot;,</span>
<span class="fc" id="L188">                        screening.getMovieTitle(),</span>
<span class="fc" id="L189">                        screening.getMovieGenre(),</span>
<span class="fc" id="L190">                        screening.getMovieLength(),</span>
<span class="fc" id="L191">                        screening.getRoomName(),</span>
<span class="fc" id="L192">                        screening.getDateTime().toString().replace(&quot;T&quot;, &quot; &quot;)</span>
                ));
<span class="fc" id="L194">            }</span>
        }
<span class="fc" id="L196">    }</span>

    @ShellMethod(value = &quot;Delete a screening from the database&quot;, key = &quot;delete screening&quot;)
    public void deleteScreening(String movieTitle, String roomName, String dateTime) {
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L201">            LocalDateTime date = LocalDateTime.parse(dateTime, formatter);</span>
<span class="fc" id="L202">            screeningController.deleteScreaning(movieTitle, roomName, date);</span>
<span class="fc" id="L203">        } else {</span>
<span class="nc" id="L204">            System.out.println(&quot;deleteScreening command is for privileged users&quot;);</span>
        }
<span class="fc" id="L206">    }</span>

    @ShellMethod(value = &quot;Create a new user.&quot;, key = &quot;sign up&quot;)
    public void createUser(String userName, String password) {
<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (userContorller.getUser(userName) == null) {</span>
<span class="fc" id="L211">            userContorller.createUser(userName, password, false);</span>
        } else {
<span class="nc" id="L213">            System.out.println(&quot;This username is already exist.&quot;);</span>
        }
<span class="fc" id="L215">    }</span>

    @ShellMethod(value = &quot;Login&quot;, key = &quot;sign in&quot;)
    public void logIn(String userName, String password) {
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if (!this.user.getLoggedIn()) {</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">            if (userContorller.logIn(userName, password)) {</span>
<span class="nc" id="L221">                this.user = userContorller.getUser(userName);</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (!this.user.getAdmin()) {</span>
<span class="nc" id="L223">                    this.user.setLoggedIn(true);</span>
<span class="nc" id="L224">                    this.user.setAdmin(false);</span>
<span class="nc" id="L225">                    System.out.println(&quot;Login successful&quot;);</span>
                } else {
<span class="nc" id="L227">                    System.out.println(&quot;Admins can sing in only with sign in privileged&quot;);</span>
<span class="nc" id="L228">                    this.user = new User();</span>
<span class="nc" id="L229">                    this.user.setLoggedIn(false);</span>
                }
            } else {
<span class="fc" id="L232">                System.out.println(&quot;Login failed due to incorrect credentials&quot;);</span>
            }
        } else {
<span class="nc" id="L235">            System.out.println(&quot;You are already logged in&quot;);</span>
        }
<span class="fc" id="L237">    }</span>

    @ShellMethod(value = &quot;Login&quot;, key = &quot;sign in privileged&quot;)
    public void adminLogIn(String userName, String password) {
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        if (!this.user.getLoggedIn()) {</span>
<span class="pc bpc" id="L242" title="1 of 2 branches missed.">            if (userContorller.logIn(userName, password)) {</span>
<span class="nc" id="L243">                this.user = userContorller.getUser(userName);</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">                if (this.user.getAdmin()) {</span>
<span class="nc" id="L245">                    this.user.setLoggedIn(true);</span>
<span class="nc" id="L246">                    System.out.println(&quot;Login successful&quot;);</span>
                } else {
<span class="nc" id="L248">                    System.out.println(&quot;Users can sing in only with sign in&quot;);</span>
<span class="nc" id="L249">                    this.user = new User();</span>
<span class="nc" id="L250">                    this.user.setLoggedIn(false);</span>
                }
            } else {
<span class="fc" id="L253">                System.out.println(&quot;Login failed due to incorrect credentials&quot;);</span>
            }
        } else {
<span class="nc" id="L256">            System.out.println(&quot;You are already logged in&quot;);</span>
        }
<span class="fc" id="L258">    }</span>

    @ShellMethod(value = &quot;Account description.&quot;, key = &quot;describe account&quot;)
    public void describeAccount() {
<span class="pc bpc" id="L262" title="2 of 4 branches missed.">        if (!this.user.getAdmin() &amp;&amp; this.user.getLoggedIn()) {</span>
<span class="nc" id="L263">            List&lt;Book&gt; books = bookController.listBooks(this.user.getUserName());</span>
<span class="nc" id="L264">            System.out.printf(&quot;Signed in with account %s%n&quot;, this.user.getUserName());</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">            if (books.isEmpty()) {</span>
<span class="nc" id="L266">                System.out.println(&quot;You have not booked any tickets yet&quot;);</span>
            } else {
<span class="nc" id="L268">                System.out.println(&quot;Your previous bookings are&quot;);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                for (Book book : books) {</span>
<span class="nc" id="L270">                    System.out.println(String.format(&quot;Seats %s on %s in room %s starting at %s for %d&quot;,</span>
<span class="nc" id="L271">                            book.getSeats(),</span>
<span class="nc" id="L272">                            book.getMovieTitle(),</span>
<span class="nc" id="L273">                            book.getRoomName(),</span>
<span class="nc" id="L274">                            book.getDate().toString().replace(&quot;T&quot;, &quot; &quot;),</span>
<span class="nc" id="L275">                            book.getPrice()</span>
                    ));
<span class="nc" id="L277">                }</span>
            }

<span class="pc bpc" id="L280" title="3 of 4 branches missed.">        } else if (this.user.getAdmin() &amp;&amp; this.user.getLoggedIn()) {</span>
<span class="nc" id="L281">            System.out.println(String.format(&quot;Signed in with privileged account '%s'&quot;, this.user.getUserName()));</span>
        } else {
<span class="fc" id="L283">            System.out.println(&quot;You are not signed in&quot;);</span>
        }
<span class="fc" id="L285">    }</span>

    @ShellMethod(value = &quot;Sign out&quot;, key = &quot;sign out&quot;)
    public void logOut() {
<span class="fc" id="L289">        this.user.setAdmin(false);</span>
<span class="fc" id="L290">        this.user.setLoggedIn(false);</span>
<span class="fc" id="L291">        System.out.println(&quot;You logged out&quot;);</span>
<span class="fc" id="L292">    }</span>

    @ShellMethod(value = &quot;Add a book&quot;, key = &quot;book&quot;)
    public void createBook(String movieTitle, String roomName, String date, String seats) {
<span class="nc bnc" id="L296" title="All 2 branches missed.">        if (!this.user.getAdmin()) {</span>
<span class="nc" id="L297">            LocalDateTime dateTime = LocalDateTime.parse(date, formatter);</span>
<span class="nc" id="L298">            String userName = this.user.getUserName();</span>
<span class="nc" id="L299">            bookController.createBook(userName, movieTitle, roomName, dateTime, seats, this.price.getPrice());</span>
        }
<span class="nc" id="L301">    }</span>

    @ShellMethod(value = &quot;Update base price&quot;, key = &quot;update base price&quot;)
    public void updatePrice(int price) {
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="nc" id="L306">            this.price.setPrice(price);</span>
        } else {
<span class="fc" id="L308">            System.out.println(&quot;This command is for admins&quot;);</span>
        }
<span class="fc" id="L310">    }</span>

    @ShellMethod(value = &quot;Create a componentprice.&quot;, key = &quot;create price component&quot;)
    public void createComponentPrice(String componentName, int componentPrice) {
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L315">            priceComponentController.createPriceComponent(componentName, componentPrice);</span>
        } else {
<span class="nc" id="L317">            System.out.println(&quot;createRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L319">    }</span>

    @ShellMethod(value = &quot;Attach a price component to a room.&quot;, key = &quot;attach price component to room&quot;)
    public void attachToRoom(String componentName, String roomName) {
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L324">            priceComponentSetController.setPriceComponentSet(componentName, &quot;room&quot;, roomName);</span>
        } else {
<span class="nc" id="L326">            System.out.println(&quot;createRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L328">    }</span>

    @ShellMethod(value = &quot;Attach a price component to a movie.&quot;, key = &quot;attach price component to movie&quot;)
    public void attachToMovie(String componentName, String movieTitle) {
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L333">            priceComponentSetController.setPriceComponentSet(componentName, &quot;movie&quot;, movieTitle);</span>
        } else {
<span class="nc" id="L335">            System.out.println(&quot;createRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L337">    }</span>

    @ShellMethod(value = &quot;Attach a price component to a screening.&quot;, key = &quot;attach price component to screening&quot;)
    public void attachToScreening(String componentName, String movieTitle, String roomName, String dateTime) {
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">        if (this.user.getAdmin()) {</span>
<span class="fc" id="L342">            LocalDateTime date = LocalDateTime.parse(dateTime, formatter);</span>
<span class="fc" id="L343">            int id = screeningController.getScreeningId(movieTitle, roomName, date);</span>
<span class="fc" id="L344">            priceComponentSetController.setPriceComponentSet(componentName, &quot;screening&quot;, String.valueOf(id));</span>
<span class="fc" id="L345">        } else {</span>
<span class="nc" id="L346">            System.out.println(&quot;createRoom command is for privileged users&quot;);</span>
        }
<span class="fc" id="L348">    }</span>

    @ShellMethod(value = &quot;Show price&quot;, key = &quot;show price for&quot;)
    public void showPrice(String movieTitle, String roomName, String date, String seats) {
<span class="fc" id="L352">        LocalDateTime dateTime = LocalDateTime.parse(date, formatter);</span>
<span class="fc" id="L353">        String userName = this.user.getUserName();</span>
<span class="fc" id="L354">        bookController.showPrice(userName, movieTitle, roomName, dateTime, seats, this.price.getPrice());</span>
<span class="fc" id="L355">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>